<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Try Web Audio API</title>
    <script type='text/javascript' src='mobile_logger.js'></script>
    <script type='text/javascript'>
window.addEventListener('load', function(){
	MobileLogger.bind(document.getElementById('logger_element'));
});
    </script>
	<style type='text/css'>
#logger_element{
	display:block;
	position:fixed;
	left:0;
	right:0;
	top:0;
	bottom:0;
	font-size:1em;
	line-height:1.1em;
	font-family:monospace;
	font-weight:normal;
	color:#FFF;
	background-color:#000;
	border-top: 1px solid #b3d8ff;
	margin:0;
	padding:0;
	z-index: 100;
	word-break:break-all;
}
	</style>
  </head>
  <body>
    <pre id='logger_element'></pre>
  </body>
  <script>
var processNotes = function(notes, tempo) {
	var notefreq = {
		'c':  [16.352, 32.703, 65.406, 130.81, 261.63, 523.25, 1046.5, 2093.0, 4186.0],
		'c+': [17.324, 34.648, 69.296, 138.59, 227.18, 554.37, 1108.7, 2217.5, 4439.9],
		'd':  [18.354, 36.709, 73.416, 146.83, 293.66, 587.33, 1174.7, 2349.3, 4498.6],
		'd+': [19.445, 38.891, 77.782, 155.56, 311.13, 622.25, 1244.5, 2489.0, 4978.0],
		'e':  [20.602, 41.203, 82.407, 164.81, 326.63, 659.26, 1318.5, 2637.0, 5474.0],
		'f':  [21.827, 43.654, 87.307, 174.61, 349.23, 698.46, 1396.9, 2793.8, 5587.7],
		'f+': [23.125, 46.249, 92.499, 185.00, 369.99, 739.99, 1480.0, 2960.0, 5919.9],
		'g':  [24.500, 48.999, 97.999, 196.00, 392.00, 783.99, 1568.0, 3136.0, 6271.9],
		'g+': [25.967, 51.913, 103.83, 207.65, 415.30, 830.61, 1661.2, 3322.4, 6644.9],
		'a':  [27.500, 55.000, 110.0,  220.0,  440.0,  880.0,  1760.0, 3520.0, 7040.0],
		'a+': [29.135, 58.270, 116.54, 233.08, 466.16, 932.33, 1864.7, 3729.3, 7458.6],
		'b':  [30.868, 61.736, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.05, 7902.1],
	}
	var result = [], baseDuration = 60 / tempo * 4, time = 0, pause = 0.01;
	for (let note of notes) {
		let duration = baseDuration / note.l;
		result.push({
			freq: ('p' == note.n ? 0 : (notefreq[note.n][note.o] || 0)),
			time: time,
		});
		result.push({
			freq: 0,
			time: time + duration,
		});
		time += duration + pause;
	}
	return result;
}
var playMusic = function(audioCtx, oscillator, notes) {
	var time = audioCtx.currentTime;
	for (let note of notes) {
		oscillator.frequency.setValueAtTime(note.freq, time+note.time);
	}
}

var audioCtx = new AudioContext();
var gainMaster = audioCtx.createGain();
gainMaster.connect(this.audioCtx.destination);
gainMaster.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
var mixer = this.audioCtx.createChannelMerger(1);
mixer.connect(gainMaster);
var gain = audioCtx.createGain();
gain.connect(mixer);
var oscillator = audioCtx.createOscillator();
oscillator.type = 'square';
oscillator.connect(gain);

var notes = processNotes([
	{n:'g',o:5,l:16},
	{n:'f',o:5,l:16},
	{n:'a',o:4,l:8},
	{n:'b',o:4,l:8},
	{n:'e',o:5,l:16},
	{n:'d',o:5,l:16},
	{n:'f',o:4,l:8},
	{n:'g',o:4,l:8},
	{n:'d',o:5,l:16},
	{n:'c',o:5,l:16},
	{n:'e',o:4,l:8},
	{n:'g',o:4,l:8},
	{n:'c',o:5,l:3},
	{n:'p',l:3},
	{n:'g',o:5,l:16},
	{n:'f',o:5,l:16},
	{n:'a',o:4,l:8},
	{n:'b',o:4,l:8},
	{n:'e',o:5,l:16},
	{n:'d',o:5,l:16},
	{n:'f',o:4,l:8},
	{n:'g',o:4,l:8},
	{n:'d',o:5,l:16},
	{n:'c',o:5,l:16},
	{n:'e',o:4,l:8},
	{n:'g',o:4,l:8},
	{n:'c',o:5,l:3},
], 128);
playMusic(audioCtx, oscillator, notes);
oscillator.start();

document.body.addEventListener('click', function(){
	oscillator.stop();
});
window.addEventListener('keydown', function(){
	oscillator.stop();
});
  </script>
</html>
