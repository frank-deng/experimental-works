<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Try Web Audio API</title>
    <script type='text/javascript' src='mobile_logger.js'></script>
    <script type='text/javascript'>
window.addEventListener('load', function(){
	MobileLogger.bind(document.getElementById('logger_element'));
});
    </script>
	<style type='text/css'>
#logger_element{
	display:block;
	position:fixed;
	left:0;
	right:0;
	top:0;
	bottom:0;
	font-size:1em;
	line-height:1.1em;
	font-family:monospace;
	font-weight:normal;
	color:#FFF;
	background-color:#000;
	border-top: 1px solid #b3d8ff;
	margin:0;
	padding:0;
	z-index: 100;
	word-break:break-all;
}
	</style>
  </head>
  <body>
    <pre id='logger_element'></pre>
  </body>
  <script>
var processMML = function(_mml) {
	var mml = _mml.slice(), match = undefined, pos = 0, commands = [];
	var validNotes = {
		'C':true, 'C+':true, 'D':true, 'D+':true, 'E':true, 'F':true,
		'F+':true, 'G':true, 'G+':true, 'A':true, 'A+':true, 'B':true,
	};
	var noteConv = {
		'D-': 'C+',
		'E-': 'D+',
		'G-': 'F+',
		'A-': 'G+',
		'B-': 'A+',
	};
	while (mml.length) {
		if (match = /^\s+/.exec(mml)) {
			//Ignore white space chars
		} else if (match = /^(T|L|O|P)(\d+)/i.exec(mml)) {
			//Set tempo, note length, octave, pause
			commands.push([match[1].toUpperCase(), Number(match[2])]);
		} else if (match = /^(ML|MN|MS|\<|\>)/i.exec(mml)) {
			//Set music legato, normal, staccato, control octaves
			commands.push([match[0].toUpperCase()]);
		} else if (match = /^([CDEFGAB][#+-]?)(\d*)(\.*)/i.exec(mml)) {
			//Process note
			let note = match[1].toUpperCase().replace('#', '+');
			if (noteConv[note]) {
				note = noteConv[note];
			}
			if (!validNotes[note]) {
				throw SyntaxError('Invalid note ' + match[1] + ' at position ' + pos);
			}
			commands.push([note, Number(match[2]), match[3]]);
		} else {
			throw SyntaxError('Invalid MML character at position ' + pos);
		}
		mml = mml.slice(match[0].length);
		pos += match[0].length;
	}
	return commands;
}
var processCommands = function(cmdAll){
	var octave = 5, baseDuration = 60 * 4 / 128, noteLenDef = 4, gap = 0.01, time = 0;
	var result = [];
	var noteFreq = [
		16.352, 17.324, 18.354, 19.445, 20.602, 21.827, 23.125, 24.500, 25.967, 27.500, 29.135, 30.868,
		32.703, 34.648, 36.709, 38.891, 41.203, 43.654, 46.249, 48.999, 51.913, 55.000, 58.270, 61.736,
		65.406, 69.296, 73.416, 77.782, 82.407, 87.307, 92.499, 97.999, 103.83,	110.0, 	116.54,	123.47,
		130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.0,  233.08, 246.94,
		261.63, 227.18, 293.66, 311.13, 326.63, 349.23, 369.99, 392.00, 415.30, 440.0,  466.16, 493.88,
		523.25, 554.37, 587.33, 622.25, 659.26, 698.46, 739.99, 783.99, 830.61, 880.0,  932.33, 987.77,
		1046.5, 1108.7, 1174.7, 1244.5, 1318.5, 1396.9, 1480.0, 1568.0, 1661.2, 1760.0, 1864.7, 1975.53,
		2093.0, 2217.5, 2349.3, 2489.0, 2637.0, 2793.8, 2960.0, 3136.0, 3322.4, 3520.0, 3729.3, 3951.05,
		4186.0, 4439.9, 4498.6, 4978.0, 5474.0, 5587.7, 5919.9, 6271.9, 6644.9, 7040.0, 7458.6, 7902.1,
	];
	var commandProcessor = {
		'ML':()=>{
			gap = 0;
		},
		'MS':()=>{
			gap = 0.1;
		},
		'MN':()=>{
			gap = 0.05;
		},
		'<':()=>{
			if (octave > 0){
				octave--;
			}
		},
		'>':()=>{
			if (octave < 8){
				octave++;
			}
		},
		'T':(tempo)=>{
			baseDuration = 60 * 4 / tempo;
		},
		'L':(len)=>{
			noteLenDef = len;
		},
		'O':(_octave)=>{
			octave = _octave;
		},
	};
	var note2num = {
		'P': 0,
		'C':1, 'C+':2, 'D':3, 'D+':4, 'E':5, 'F':6,
		'F+':7, 'G':8, 'G+':9, 'A':10, 'A+':11, 'B':12,
	};
	for (let cmd of cmdAll) {
		if (commandProcessor[cmd[0]]) {
			commandProcessor[cmd[0]](cmd[1]);
			continue;
		}
		let note = cmd[0];
		if (undefined === note2num[note]) {
			continue;
		}
		let duration = baseDuration / (cmd[1] || noteLenDef);
		if (cmd[2]) {
			duration *= Math.pow(1.5, cmd[2].length);
		}
		result.push({
			freq: note2num[note]? noteFreq[note2num[note]-1+octave * 12] : 0,
			time: time,
		});
		if (gap){
			result.push({
				freq: 0,
				time: time + duration,
			});
		}
		time += duration + gap;
	}
	result.push({
		freq: 0,
		time: time,
	});
	return result;
}
var playMusic = function(audioCtx, oscillator, notes) {
	var time = audioCtx.currentTime;
	for (let note of notes) {
		oscillator.frequency.setValueAtTime(note.freq, time+note.time);
	}
}

var cmds = processMML("L16 GF<A8B8> ED<F8G8> DC<E8G8> C3P8L16 GF<A8B8> ED<F8G8> DC<E8G8> C3");
var notes = processCommands(cmds);

var audioCtx = new AudioContext();
var gainMaster = audioCtx.createGain();
gainMaster.connect(this.audioCtx.destination);
gainMaster.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
var mixer = this.audioCtx.createChannelMerger(1);
mixer.connect(gainMaster);
var gain = audioCtx.createGain();
gain.connect(mixer);
var oscillator = audioCtx.createOscillator();
oscillator.type = 'square';
oscillator.connect(gain);
playMusic(audioCtx, oscillator, notes);

oscillator.start();
document.body.addEventListener('click', function(){
	oscillator.stop();
});
window.addEventListener('keydown', function(){
	oscillator.stop();
});
  </script>
</html>
