<!DOCTYPE html>
<html>
	<head>
		<meta name='viewport' id='viewport' content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no'/>
		<meta charset='UTF-8'/>
		<title>二进制文件实验</title>
		<style>
template{display:none;}
#logger_element{
	display:block;
	position:fixed;
	left:0;
	right:0;
	bottom:0;
	height:12em;
	font-size:1em;
	line-height:1.1em;
	font-family:monospace;
	font-weight:normal;
	color:#000;
	background-color:#ccc;
	border-top:1px solid #000;
	margin:0;
	padding:0;
}
		</style>
		<script type='text/javascript' src='mobile_logger.min.js'></script>
        <script type='text/javascript'>
window.addEventListener('load', function(){
	MobileLogger.bind(document.getElementById('logger_element'));
});
        </script>
		<script type='text/javascript' src='vue.js'></script>
        <script type='text/javascript' src='vue-router.js'></script>
	</head>
	<body>
		<div id='app'>
			<input type='file' @change='onUploadFile'/>
			<button @click='onSaveFont'>Save</button>
		</div>
		<pre id='logger_element'></pre>
	</body>
	<script>
function InvalidFormatError(msg) {
	this.message = msg;
	var error = new Error(this.message);
	this.stack = error.stack;
}
InvalidFormatError.prototype = new Error();
InvalidFormatError.prototype.name = InvalidFormatError.name;
InvalidFormatError.prototype.constructor = InvalidFormatError;

function FontPC98(bufferOrig){
	var view = new DataView(bufferOrig);
	var validateBmp = function(buffer){
		var signature = view.getUint16(0, true);
		if (signature != 0x4d42) {
			throw new InvalidFormatError('Invalid signature');
		}
		var bmpsize = view.getUint32(2, true);
		if (buffer.byteLength != bmpsize) {
			throw new InvalidFormatError('BMP file size mismatch');
		}
		var planes = view.getUint16(26, true);
		if (planes != 1) {
			throw new InvalidFormatError('Color plane not 1');
		}
	}
	validateBmp(bufferOrig);

	var offset = view.getUint32(10, true);
	var buffer = bufferOrig.slice(0);
	view = new DataView(buffer, offset);

	this.getBuffer = function(){
		return buffer.slice(0);
	}
}

function FontManager(){
	this.loadFont = function(params){
		var reader = new FileReader();
		reader.addEventListener('load', function(){
			var font = undefined;
			try {
				font = new FontPC98(this.result);
			} catch(e) {
				if (typeof params.error === 'function'){
					params.error(e, this.result);
				}
			}
			if (typeof params.success === 'function'){
				params.success(font);
			}
		});
		reader.addEventListener('abort', function(e){
			if (typeof params.abort === 'function'){
				params.abort(e);
			}
		});
		reader.readAsArrayBuffer(params.src);
	}
	this.saveFont = function(font){
		if (!(font instanceof FontPC98)) {
			throw Error('Not a saveable instance');
		}
		var file = new File([new Blob([font.getBuffer()])], 'font.bmp', {type: "image/x-bmp"});
		var dataURL = window.URL.createObjectURL(file);
		var link = document.createElement("a");
		link.href = dataURL;
		link.download = 'font.bmp';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
		delete link;
		window.URL.revokeObjectURL(dataURL);
	}
}

var fontManager = new FontManager();
var vm = new Vue({
	el: '#app',
	data: {
		uploadedFile: undefined,
		font: undefined,
	},
	methods:{
		onUploadFile: function(e){
			var files = e.target.files || e.dataTransfer.files;
			if (files.length) {
				fontManager.loadFont({
					src: files[0],
					success: function(font){
						vm.font = font;
					},
					error: function(e, data){
						throw e;
					}
				});
			}
		},
		onSaveFont: function(e) {
			if (this.font) {
				fontManager.saveFont(this.font);
			} else {
				console.warn('No font file uploaded');
			}
		}
	},
});
	</script>
</html>
