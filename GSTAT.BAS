DEFINT A-Z

DIM SHARED B(15) AS INTEGER,N(15040) AS INTEGER,T(9999)AS INTEGER
DIM SHARED RES(1,15) AS LONG
DEF SEG=VARSEG(N(0))
RANDOMIZE TIMER
FOR I=0 TO 10:B(I)=2^I:NEXT I

PRINT "Initializing...";
CALL INITNUM
CLS
LOCATE 25,1:PRINT "Press any key to exit";

T0#=TIMER
WHILE INKEY$=""
  CALL PRINTSTAT
  PRINT USING "##.##s per round";TIMER-T0#:T0#=TIMER

  G=GUESS
  G=G-1
  RES(0,G)=RES(0,G)+1
  G=GUESSM
  G=G-1
  RES(1,G)=RES(1,G)+1
WEND

DEF SEG:END

SUB PRINTSTAT
  STATIC RMAX AS INTEGER
  IF RMAX=0 THEN RMAX=7
  FOR I=8 TO 15
    IF RES(0,I)>0 OR RES(1,I)>0 THEN ROWS=I
  NEXT I
  LOCATE 1,1:PRINT "Guesses     Normal Mastermind"
  FOR I=0 TO RMAX
    PRINT LTRIM$(STR$(I+1));TAB(9);
    PRINT USING "########## ##########";RES(0,I);RES(1,I)
  NEXT I
END SUB

SUB INITNUM
  P=VARPTR(N(0))
  PU=P+20000
  FOR I=0 TO 9999
    D0=(((I\10) MOD 10)*16) OR (I MOD 10)
    D1=((I\1000)*16) OR ((I\100) MOD 10)
    IF UNIQDIGIT(D0,D1) THEN
      POKE PU,D0:PU=PU+1:POKE PU,D1:PU=PU+1
    END IF
    POKE P,D0:P=P+1:POKE P,D1:P=P+1
  NEXT I
END SUB

FUNCTION UNIQDIGIT(D0 AS INTEGER,D1 AS INTEGER)
  DIM MAP AS INTEGER,D AS INTEGER
  UNIQDIGIT=0
  MAP=B(D0\16)
  D=D0 AND 15
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION ELSE MAP=MAP OR B(D)
  D=D1\16
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION ELSE MAP=MAP OR B(D)
  D=D1 AND 15
  IF (MAP AND B(D))<>0 THEN EXIT FUNCTION ELSE MAP=MAP OR B(D)
  UNIQDIGIT=1
END FUNCTION

FUNCTION COMP(A AS INTEGER,B AS INTEGER)
  DIM DA0 AS INTEGER,DA1 AS INTEGER,DB0 AS INTEGER,DB1 AS INTEGER
  DIM MA AS INTEGER,MB AS INTEGER,RS AS INTEGER
  DA0=PEEK(20000+A*2):DA1=PEEK(20001+A*2)
  DB0=PEEK(20000+B*2):DB1=PEEK(20001+B*2)
  DA=DA0\16:DB=DB0\16
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=DA0 AND 15:DB=DB0 AND 15
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=DA1\16:DB=DB1\16
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  DA=DA1 AND 15:DB=DB1 AND 15
  IF DA=DB THEN RS=RS+16 ELSE MA=MA OR B(DA):MB=MB OR B(DB)
  MA=MA AND MB:WHILE MA<>0:MA=MA AND (MA-1):RS=RS+1:WEND
  COMP=RS
END FUNCTION

FUNCTION COMPM(A AS INTEGER,B AS INTEGER)
  DIM DA0 AS INTEGER,DA1 AS INTEGER,DB0 AS INTEGER,DB1 AS INTEGER
  DIM M(9,1) AS INTEGER,I AS INTEGER,RS AS INTEGER
  DA0=PEEK(A*2):DA1=PEEK(1+A*2)
  DB0=PEEK(B*2):DB1=PEEK(1+B*2)
  DA=DA0\16:DB=DB0\16
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=DA0 AND 15:DB=DB0 AND 15
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=DA1\16:DB=DB1\16
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  DA=DA1 AND 15:DB=DB1 AND 15
  IF DA=DB THEN RS=RS+16 ELSE M(DA,0)=M(DA,0)+1:M(DB,1)=M(DB,1)+1
  FOR I=0 TO 9:DA0=M(I,0):DA1=M(I,1)
    IF DA0<DA1 THEN RS=RS+DA0 ELSE RS=RS+DA1
  NEXT I
  COMPM=RS
END FUNCTION

FUNCTION GUESS()
  DIM ANS AS INTEGER,G AS INTEGER,TL AS INTEGER,TP AS INTEGER,TIMES AS INTEGER
  DIM I AS INTEGER
  ANS=INT(RND*5039):G=INT(RND*5039)
  IF ANS=G THEN GUESS=1:EXIT FUNCTION
  RS=COMP(ANS,G):TL=0:TIMES=1
  FOR I=0 TO 5039
    IF I<>G THEN
      RS2=COMP(I,G)
      IF RS=RS2 THEN T(TL)=I:TL=TL+1
    END IF
  NEXT I
  WHILE TL>1
    G=INT(RND*(TL-1)):RS=COMP(ANS,T(G))
    TP=0:FOR I=0 TO TL-1
      IF I<>G THEN
        RS2=COMP(T(I),T(G))
        IF RS=RS2 THEN T(TP)=T(I):TP=TP+1
      END IF
    NEXT I
    TL=TP:TIMES=TIMES+1
  WEND
  GUESS=TIMES
END FUNCTION

FUNCTION GUESSM()
  DIM ANS AS INTEGER,G AS INTEGER,TL AS INTEGER,TP AS INTEGER,TIMES AS INTEGER
  DIM I AS INTEGER
  ANS=INT(RND*9999):G=INT(RND*9999)
  IF ANS=G THEN GUESSM=1:EXIT FUNCTION
  RS=COMPM(ANS,G):TL=0:TIMES=1
  FOR I=0 TO 9999
    IF I<>G THEN
      RS2=COMPM(I,G)
      IF RS=RS2 THEN T(TL)=I:TL=TL+1
    END IF
  NEXT I
  WHILE TL>1
    G=INT(RND*(TL-1)):RS=COMPM(ANS,T(G))
    TP=0:FOR I=0 TO TL-1
      IF I<>G THEN
        RS2=COMPM(T(I),T(G))
        IF RS=RS2 THEN T(TP)=T(I):TP=TP+1
      END IF
    NEXT I
    TL=TP:TIMES=TIMES+1
  WEND
  GUESSM=TIMES
END FUNCTION

